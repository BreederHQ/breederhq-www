---
/**
 * Contact Form Component
 * Automatically tracks form interactions and captures leads with UTM attribution
 */

interface Props {
  formId?: string;
  submitText?: string;
  source?: string;
}

const {
  formId = 'contact-form',
  submitText = 'Get Started',
  source = 'contact_form'
} = Astro.props;
---

<form
  id={formId}
  class="contact-form"
  data-source={source}
>
  <div class="form-group">
    <label for="name">Name *</label>
    <input
      type="text"
      id="name"
      name="name"
      required
      placeholder="Your name"
    />
  </div>

  <div class="form-group">
    <label for="email">Email *</label>
    <input
      type="email"
      id="email"
      name="email"
      required
      placeholder="you@example.com"
    />
  </div>

  <div class="form-group">
    <label for="phone">Phone</label>
    <input
      type="tel"
      id="phone"
      name="phone"
      placeholder="(555) 123-4567"
    />
  </div>

  <div class="form-group">
    <label for="company">Company</label>
    <input
      type="text"
      id="company"
      name="company"
      placeholder="Your company name"
    />
  </div>

  <div class="form-group">
    <label for="interest">I'm interested in...</label>
    <select id="interest" name="interest">
      <option value="">Select an option</option>
      <option value="dogs">Dog Breeding</option>
      <option value="cats">Cat Breeding</option>
      <option value="horses">Horse Breeding</option>
      <option value="goats">Goat Breeding</option>
      <option value="rabbits">Rabbit Breeding</option>
      <option value="sheep">Sheep Breeding</option>
      <option value="other">Other</option>
    </select>
  </div>

  <div class="form-group">
    <label for="message">Message</label>
    <textarea
      id="message"
      name="message"
      rows="4"
      placeholder="Tell us about your breeding operation..."
    ></textarea>
  </div>

  <button type="submit" class="submit-btn">
    {submitText}
  </button>

  <div class="form-message" style="display: none;"></div>
</form>

<script>
  import { trackFormStart, trackFormSubmit, trackConversion, getStoredUTMParameters } from '../lib/tracking';

  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.contact-form');

    forms.forEach((form) => {
      const formElement = form as HTMLFormElement;
      const formId = formElement.id;
      const source = formElement.dataset.source || 'contact_form';
      const messageDiv = formElement.querySelector('.form-message') as HTMLElement;
      let formStarted = false;

      // Track form start on first interaction
      formElement.addEventListener('focusin', () => {
        if (!formStarted) {
          formStarted = true;
          trackFormStart(formId);
        }
      }, { once: true });

      // Handle form submission
      formElement.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = formElement.querySelector('button[type="submit"]') as HTMLButtonElement;
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';

        try {
          const formData = new FormData(formElement);
          const data: Record<string, any> = {
            source,
          };

          // Get form fields
          formData.forEach((value, key) => {
            data[key] = value;
          });

          // Add UTM parameters for attribution
          const utmParams = getStoredUTMParameters();
          Object.assign(data, utmParams);

          // Submit to API
          const response = await fetch('/api/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok) {
            // Track successful submission
            trackFormSubmit(formId, true);
            trackConversion({
              conversionType: 'contact',
              ...utmParams,
            });

            // Show success message
            messageDiv.textContent = result.message || 'Thank you! We\'ll be in touch soon.';
            messageDiv.className = 'form-message success';
            messageDiv.style.display = 'block';

            // Reset form
            formElement.reset();

            // Redirect after delay (optional)
            setTimeout(() => {
              // window.location.href = '/thank-you';
            }, 2000);
          } else {
            throw new Error(result.error || 'Submission failed');
          }
        } catch (error) {
          console.error('Form submission error:', error);
          trackFormSubmit(formId, false);

          messageDiv.textContent = 'Something went wrong. Please try again.';
          messageDiv.className = 'form-message error';
          messageDiv.style.display = 'block';
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });
    });
  });
</script>

<style>
  .contact-form {
    max-width: 500px;
    margin: 0 auto;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .submit-btn {
    width: 100%;
    padding: 0.75rem 1.5rem;
    background-color: #2563eb;
    color: white;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .submit-btn:hover:not(:disabled) {
    background-color: #1d4ed8;
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .form-message {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 0.375rem;
    font-weight: 500;
  }

  .form-message.success {
    background-color: #d1fae5;
    color: #065f46;
    border: 1px solid #10b981;
  }

  .form-message.error {
    background-color: #fee2e2;
    color: #991b1b;
    border: 1px solid #ef4444;
  }
</style>
